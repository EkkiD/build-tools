#!/usr/bin/python
import sys
import subprocess as s
import time
import socket
if len(sys.argv) != 7:
  print "usage: %s <host> <port> <max pings> <delay> <failures to reboot> <log>"
  s.call(['reboot-user'])
else:
  try:
    hostname = sys.argv[1]
    port = int(sys.argv[2])
    max_pings = int(sys.argv[3])
    delay = int(sys.argv[4])
    failure_max = int(sys.argv[5])
    log = sys.argv[6]
  except:
    print "usage: %s <host> <port> <max pings> <delay> <failures2reboot> <log>"
  failcount = 0
  faileddns = False
  while faileddns is False:
    try:
      ip = socket.gethostbyaddr(hostname)
    except socket.gaierror:
      failcount += 1
    except socket.herror:
      
    if ip:
      host = ip[2][0]
      break
    else:
      failcount += 1
    if failcount > max_pings:
      faileddns = True
    else:
      time.sleep(delay)
  failcount = 0
  failedconnect = False
  while True:
    time.sleep(delay)
    try:
      s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
      s.connect((hostname, port))
      s.close()
    except socket.error, msg:
      failcount += 1
      if failcount > failure_max:
        f=open(log, 'a+')
        print >> f, '%s UTC Device lost connection, rebooting' % \
          time.asctime(time.gmtime())
        s.call(['reboot-user'])
