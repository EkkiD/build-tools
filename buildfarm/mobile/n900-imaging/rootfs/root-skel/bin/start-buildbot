#!/bin/sh

. /etc/mozconf

${NGINXPREFIX}/sbin/nginx -c ${NGINXPREFIX}/conf/nginx.conf

# i=0
# while true ; do
#     i=$(($i + 1))
#     ping -c 1 $BBHOST
#     if [[ $? -eq 0 ]] ; then
# 	break
#     elif [[ $i -gt $PINGMAX ]] ; then
# 	error "Cannot reach buildbot master"
# 	reboot
#     fi
#     sleep $PINGDELAY
# done

# setsid /bin/verify-network $BBHOST $BBPORT $PINGMAX $PINGDELAY \
#     $PINGMAXREBT $HWLOG

rm /tmp/shutdown #this is not the power state you are looking for
touch /tmp/reboot #I wonder if the jedi mind trick works on n900s?
su - -c "/bin/uptime-check.py"
su - -c "/bin/run-ntp.py"
su - user -c "buildbot create-slave --maxdelay=20 $BBDIR ${BBHOST}:${BBPORT} \
   $BBUSER $BBPASS"
cp $HWLOG $BBDIR/info/admin ; cp $CONFIGED ${BBDIR}/info/host
su - user -c "buildbot start $BBDIR"